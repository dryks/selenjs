/**
 * PDD-TEST v3.1
 * © 2009-2014 pdd-test.hint.su
 */

var pddTestConfig = {};

/**
 * Тема оформления.
 */
pddTestConfig.theme = 'gray';

/**
 * Вкладка по умолчанию.
 *
 * Возможные значения:
 *  - examine
 *  - numbers
 *  - categories
 */
pddTestConfig.defaultTab = 'examine';

/**
 * Обратный отсчёт таймера.
 *
 * Этот режим так же можно изменить кликая по таймеру.
 */
pddTestConfig.countdown = false;

/**
 * Подмигивать индикатором после каждого ответа.
 */
pddTestConfig.blink = true;

/**
 * Поддержка клавиатуры.
 *
 * Используемые клавишы: 1, 2, 3, 4, 5, ↵, ↑, ↓, 0, <space>, <esc>
 */
pddTestConfig.keyboard = true;
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/define("config",["jquery","underscore","backbone"],function(e,t,n){var r={};return r.el="#pdd-test",r.blink=!0,r.defaultTab="examine",r.keyboard=!0,r.basePath=e("#pdd-test-script").data("main").split("/").slice(0,-1).join("/"),r.imagesPath=r.basePath+"/ab_images",r.theme="gray",r.countdown=!1,r.msg=[],r.msg[0]=decodeURI("%D0%9F%D0%BE%D0%B4%D1%81%D0%BA%D0%B0%D0%B7%D0%BA%D0%B8%20%D0%BD%D0%B0%20%D1%8D%D0%BA%D0%B7%D0%B0%D0%BC%D0%B5%D0%BD%D0%B5%20%D0%B7%D0%B0%D0%BF%D1%80%D0%B5%D1%89%D0%B5%D0%BD%D1%8B"),r.msg[1]=decodeURI("%D0%BC%D0%B8%D0%BD."),r.msg[2]=decodeURI("%D1%81%D0%B5%D0%BA."),r.msg[3]=decodeURI("%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B9%20%D1%80%D0%B5%D0%B7%D1%83%D0%BB%D1%8C%D1%82%D0%B0%D1%82:%20?%20%D0%B8%D0%B7%2020"),r.msg[4]=decodeURI("%D0%9D%D0%B5%20%D0%B2%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D1%8F%D0%BB%D1%81%D1%8F"),e.extend(r,window.pddTestConfig||{}),r.themeSwitcher="#pdd-test-theme-switcher",r.themePath=r.basePath+"/themes/"+r.theme,r}),define("template",["jquery","config"],function(e,t){var n=_.extend({},Backbone.Events);return n.templates=[],n.loadTemplates=function(){var n=this;e.ajax({url:t.basePath+"/themes/templates.html",async:!1,success:function(t){var r=e("script",e("<div>"+t+"</div>"));r.each(function(){var t=e(this),r=t.attr("id").split("-")[1];n.templates[r]=t.html()})}})},n.render=function(n,r){var i=_.template(this.templates[n])(r);e(t.el).find(".pdd-tpl").remove(),e(t.el).append(i),this.trigger("template:rendered",n)},n.get=function(e){return this.templates[e]},n}),define("tabs-view",["jquery","backbone","template","config"],function(e,t,n,r){return new(t.View.extend({el:r.el,events:{"click li":"onChange"},render:function(t){var r=_.template(n.templates.tabs);e(this.el).prepend(r)},onChange:function(t){if(!e(t.currentTarget).hasClass("pdd-active")){var n=e(t.currentTarget).attr("id").split("-")[1];this._setActiveTab(n),this.trigger("changed",n)}},_setActiveTab:function(t){$tab=e("#pdd-"+t+"-link"),$tab.hasClass("pdd-active")||($tab.siblings().removeClass("pdd-active"),$tab.addClass("pdd-active"))},setActiveTab:function(e){this._setActiveTab(e),this.trigger("changed",e)},getActiveTab:function(){return $tab=e("#pdd-tabs").find(".pdd-active").attr("id").split("-")[1]}}))}),define("logger",[],function(){var e={data:{}};return e.get=function(e){return this.data[e]},e.set=function(t,n){this.data[t]=n,e.saveData()},e.loadData=function(){var t=document.cookie.split(";");for(var n=0,r=t.length;n<r;n++){var i=t[n].split("=");if(i[0].replace(/^\s+|\s+$/g,"")=="pdd-test-statistics"){e.data=JSON.parse(i[1]);break}}},e.saveData=function(){var t=new Date;t.setTime(t.getTime()+315576e6);var n=JSON.stringify(e.data);document.cookie="pdd-test-statistics ="+n+"; expires="+t.toGMTString()+"; path=/"},e.getSummary=function(){var e={passed:0,failed:0,remain:0,average:0},t=0;for(var n=0;n<40;n++){var r=this.data[n+"c"+0];r?(e[r>=18?"passed":"failed"]++,t+=r):e.remain++}return e.average=t?(t/(e.passed+e.failed)).toFixed(1):0,e},e.loadData(),e}),define("router",["backbone","config"],function(e,t){return new(e.Router.extend({routes:{"":t.defaultTab,examine:"examine",numbers:"numbers",categories:"categories","examine/:bn":"examineBilet","numbers/:bn":"numbersBilet","categories/:cat/:bn":"categoryBilet"},"goto":function(e){this.navigate(e,{trigger:!0})}}))}),define("numbers-view",["jquery","backbone","logger","router","template","config"],function(e,t,n,r,i,s){return new(t.View.extend({el:s.el,events:{"click #pdd-bilets td":"startBilet"},render:function(){i.render("numbers"),e("#pdd-bilets").find("td").each(function(t,r){var i=e(r),o=i.text().split(" ")[1]+"c0",u=n.get(o);u?(i.attr("title",s.msg[3].replace("?",u)),i.addClass(u>=18?"pdd-bilet-passed":"pdd-bilet-failed")):i.attr("title",s.msg[4])})},startBilet:function(t){var n=e(t.currentTarget).text().split(" ")[1];r.goto("numbers/"+n)}}))}),define("examine-view",["backbone","router","template","config"],function(e,t,n,r){return new(e.View.extend({el:r.el,events:{"click #pdd-examine .pdd-sbmt":"startBilet"},startBilet:function(e){var n=Math.floor(Math.random()*40+1);t.goto("examine/"+n)},render:function(e){n.render("examine")}}))}),define("categories-view",["jquery","backbone","logger","router","template","config"],function(e,t,n,r,i,s){return new(t.View.extend({el:s.el,events:{"click .pdd-category":"toggleCategory","click .pdd-category-bilets td":"startBilet"},toggleCategory:function(t){var n=e(t.currentTarget).children(".pdd-category-bilets"),r=e("#pdd-test").find(".pdd-category-bilets:visible");r.length==0?n.show():n.is(":visible")?n.hide():(r.hide(),n.show())},render:function(){i.render("categories"),e("#pdd-categories").find("td").each(function(t,r){var i=e(r),o=i.parents(".pdd-category").attr("id").split("-")[2],u=i.text().split(" ")[1]+"c"+o,a=n.get(u);a?(i.attr("title",s.msg[3].replace("?",a)),i.addClass(a>=18?"pdd-bilet-passed":"pdd-bilet-failed")):i.attr("title",s.msg[4])})},startBilet:function(t){$td=e(t.currentTarget);var n=$td.parents(".pdd-category").attr("id").split("-")[2],i=$td.text().split(" ")[1];r.goto("categories/"+n+"/"+i)}}))}),define("timer",["jquery","config"],function(e,t){var n=function(e){this.el=e,this.val=[0,0,0,0],this.countdown=t.countdown,this.interval=null};return n.prototype.render=function(){e(this.el).html(this.toString())},n.prototype.start=function(){var e=this;this.interval=setInterval(function(){e.tick()},1e3)},n.prototype.stop=function(){clearInterval(this.interval)},n.prototype.toString=function(){var e=this.val[3]+""+this.val[2],t=this.val[1]+""+this.val[0];return this.countdown&&(e=""+(20-e-(t=="00"?0:1)),t=t=="00"?"00":60-t+"",e.length==1&&(e="0"+e),t.length==1&&(t="0"+t)),e+":"+t},n.prototype.tick=function(){var e=this;e.val[0]++,e.val[0]>9&&(e.val[0]=0,e.val[1]++),e.val[1]>5&&(e.val[1]=0,e.val[2]++),e.val[2]>9&&(e.val[2]=0,e.val[3]++),e.val[3]==2&&(e.expire=!0,e.stop()),e.render()},n.prototype.getTotal=function(){var n="",r=10*this.val[3]+this.val[2];r&&(n+=r+" "+t.msg[1]+" ");var i=10*this.val[1]+this.val[0];return i&&(n+=i+" "+t.msg[2]),e.trim(n)},n}),define("bilet-view",["jquery","backbone","timer","tabs-view","router","template","config"],function(e,t,n,r,i,s,o){var u={el:o.el,timer:null};return u.initialize=function(){o.keyboard&&e(document).keydown(this.keyboardHandler),this.listenTo(s,"template:rendered",function(e){e!="bilet"&&this.timer&&this.timer.stop()})},u.render=function(){this.model.questionIndex==0&&(this.timer=new n("#pdd-bilet-time"),this.timer.start()),s.render("bilet",{bilet:this.model,timer:this.timer}),r.getActiveTab()=="examine"&&e("#pdd-bilet-comment").html(o.msg[0])},u.renderResult=function(){s.render("result",{bilet:this.model,timer:this.timer})},u.events={"submit #pdd-bilet-form":"questionSubmit","click #pdd-bilet-toggle-comment":"toggleComment","click #pdd-bilet-close":"closeBilet","click #pdd-bilet-proceed":"closeBilet",'change #pdd-bilet-form input[type="radio"]':function(){e("#pdd-bilet").find(".pdd-sbmt").removeClass("pdd-disabled")},"click #pdd-bilet-time":function(){this.timer.countdown=!this.timer.countdown,this.timer.render()}},u.setIndicator=function(t){var n=t?this.model.questionIndex-1:this.model.questionIndex,r=e("#pdd-res-line").find("li:eq("+n+")").last(),i=t?"pdd-success-qst":"pdd-fail-qst";r.addClass(i),o.blink&&(setTimeout(function(){r.removeClass(i)},150),setTimeout(function(){r.addClass(i)},300))},u.questionSubmit=function(t){$form=e(t.currentTarget);if($form.find("button").hasClass("pdd-disabled"))return!1;var n=$form.find("input:checked").val(),r=this.model.activeQuestion;return r.result===undefined&&!this.model.processAnswer(n)?(e(t.currentTarget).find("label").each(function(t,i){t++,t==n?e(i).addClass("pdd-fail-ans"):t==r.right&&e(i).addClass("pdd-right-ans")}),e("#pdd-bilet-comment").html(r.comment),this.showComment(),this.setIndicator(!1)):this.model.questionIndex<19?(this.model.next(),this.render(),this.setIndicator(!0)):(this.timer.stop(),this.model.finish(),this.renderResult(),this.trigger("bilet:finished")),!1},u.showComment=function(){e("#pdd-bilet-comment").slideDown()},u.toggleComment=function(){this.model.logPrompt(),e("#pdd-bilet-comment").slideToggle()},u.closeBilet=function(){i.goto(r.getActiveTab())},u.keyboardHandler=function(t){var n=e("#pdd-bilet");if(n.length==0)return;var r=e(document.activeElement),i=r.parents("#pdd-test").length||r.prop("tagName")=="BODY";if(i){if(e.inArray(t.which,[49,50,51,52,53])!=-1)var s=t.which-48;if(e.inArray(t.which,[97,98,99,100,101])!=-1)var s=t.which-96;s?e("#pdd-bilet-ans-"+s).find("input").trigger("click").focus():t.which==32||t.which==48||t.which==96?e("#pdd-bilet-toggle-comment").trigger("click"):t.which==13?(e("#pdd-bilet-form").find(".pdd-sbmt").trigger("click"),t.preventDefault()):t.which==38||t.which==40?n.find("input:checked").val()||(e("#pdd-bilet-ans-1").find("input").trigger("click").focus(),t.preventDefault()):t.which==27&&e("#pdd-bilet-close").trigger("click")}},new(t.View.extend(u))}),define("statistics-view",["backbone","logger","template"],function(e,t,n){return new(e.View.extend({el:"#pdd-statistics",render:function(){var e=_.template(n.get("statistics"))({summary:t.getSummary()});this.$el.html(e)}}))}),define("bilet-model",["backbone","logger"],function(e,t){return e.Model.extend({result:0,prompt:0,activeQuestion:null,questionIndex:-1,initialize:function(){this.fetch(),this.next()},next:function(){this.questionIndex++,this.activeQuestion=this.get("questions")[this.questionIndex]},processAnswer:function(e){return this.activeQuestion.result=e==this.activeQuestion.right,this.activeQuestion.result||(this.activeQuestion.prompt=!1),this.activeQuestion.result},logPrompt:function(){this.activeQuestion.prompt=this.activeQuestion.result===undefined},finish:function(){var e=this.get("questions");for(var n=0;n<=19;n++)e[n].result&&this.result++,e[n].prompt&&this.prompt++;t.set(this.id,this.result)}})}),define("bilets",["jquery","underscore","config"],function(e,t,n){var r={};return r.questions=[],r.get=function(e){var r=e.split("c"),i=r[0],s=r[1];this.questions.length>0||this.load(!1);var o={},u=20*(i-1),a;return s>0?(a=t.where(this.questions,{cat:s}),a=t.sortBy(a,function(e){return parseInt(e.id-(e.bn-1)*20)}),a=a.slice(u,u+20)):a=this.questions.slice(u,u+20),o.questions=JSON.parse(JSON.stringify(a)),t.each(o.questions,function(e,t){e.img?e.imgSrc=n.imagesPath+"/"+e.img:e.imgSrc=n.themePath+"/default.png";var r=new Image;r.src=e.imgSrc}),o},r.load=function(t){var r=localStorage.getItem("pdd-test.questions");r?this.questions=JSON.parse(r):(self=this,e.ajax({url:n.basePath+"/ab-bilets.json",async:t,dataType:"json",success:function(e){localStorage.setItem("pdd-test.questions",JSON.stringify(e)),self.questions=e}}))},r}),require.config({paths:{"tabs-view":"modules/tabs-view","bilet-model":"modules/bilet-model",bilets:"modules/bilets","bilet-view":"modules/bilet-view","categories-view":"modules/categories-view",config:"modules/config","examine-view":"modules/examine-view",logger:"modules/logger","numbers-view":"modules/numbers-view",router:"modules/router","statistics-view":"modules/statistics-view",template:"modules/template",timer:"modules/timer",jquery:"//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min",underscore:"//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min",backbone:"//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min"},shim:{underscore:{exports:"_"},backbone:{deps:["underscore","jquery"],exports:"Backbone"},jquery:{exports:"$"}}}),require(["jquery","underscore","backbone","tabs-view","numbers-view","examine-view","categories-view","bilet-view","statistics-view","bilet-model","router","template","bilets","config"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){n.sync=function(e,t,n){var r=h.get(t.id);n.success(r)},e("<link>",{rel:"stylesheet",type:"text/css",id:"pdd-test-theme",href:p.themePath+"/style.css"}).appendTo("head"),h.load(!0),c.loadTemplates(),e(function(){e("#pdd-test").empty();var c=null;r.render(),a.render(),l.on("route:examine",function(){r.setActiveTab("examine"),s.render()}),l.on("route:numbers",function(){r.setActiveTab("numbers"),i.render()}),l.on("route:categories",function(){r.setActiveTab("categories"),o.render()}),u.on("bilet:finished",function(){a.render()}),l.on("route:examineBilet",function(e){r._setActiveTab("examine"),c=new f({id:e+"c0"}),u.model=c,u.render()}),l.on("route:numbersBilet",function(e){r._setActiveTab("numbers"),c=new f({id:e+"c0"}),u.model=c,u.render()}),l.on("route:categoryBilet",function(e,t){r._setActiveTab("categories"),c=new f({id:t+"c"+e}),u.model=c,u.render()}),l.listenTo(r,"changed",function(e){l.goto(e)}),n.history.start();var h=e(p.themeSwitcher);h.length>0&&h.change(function(){p.theme=e(this).val(),p.themePath=p.basePath+"/themes/"+p.theme,e("#pdd-test-theme").attr("href",p.themePath+"/style.css");if(c){var n=c.get("questions"),r=p.themePath+"/default.png";t.each(n,function(e){e.img||(e.imgSrc=r)}),e('#pdd-bilet-qst-img[src$="default.png"]').attr("src",r)}})})}),define("../pdd-test",function(){});